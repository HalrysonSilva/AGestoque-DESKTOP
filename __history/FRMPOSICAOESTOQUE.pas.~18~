unit FRMPOSICAOESTOQUE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Data.DB, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, MemDS, DBAccess, Uni;

type
  TFormposicaoest = class(TForm)
    Panel1: TPanel;
    Panel2: TPanel;
    Label1: TLabel;
    DBGridprodutos: TDBGrid;
    Label2: TLabel;
    DBGridpedidos: TDBGrid;
    QRYPRODUTOSABERTOS: TUniQuery;
    DSQRYPRODUTOSABERTOS: TDataSource;
    QRYPEDIDOS: TUniQuery;
    DSQRYPEDIDOS: TDataSource;
    QRYCODINTERNO: TUniQuery;
    procedure CarregarPosicaoEExibir;

    procedure QRYPRODUTOSABERTOSAfterScroll(DataSet: TDataSet);private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Formposicaoest: TFormposicaoest;

implementation

{$R *.dfm}

uses CONEXAOBD, FRMAGESTOQUE, FRMMOVIMENTO, FRMSelectproduto, FRMSENHA;



procedure TFormposicaoest.CarregarPosicaoEExibir;
var
  sCodInterno: string;
  iLkProduto: Integer;
  sNomeProduto: string;
begin
  // 1. COLETA DO CÓDIGO INTERNO DO PRODUTO ATIVO NO FRMMENU (DBText50)
  if not Assigned(frmmenu) or not Assigned(frmmenu.DBText50) or (Trim(frmmenu.DBText50.Caption) = '') then
  begin
    ShowMessage('Nenhum produto selecionado (Código Interno está vazio).');
    Exit;
  end;

  sCodInterno := Trim(frmmenu.DBText50.Caption);

  // 2. BUSCA O LKPRODUTO (Controle) DO PRODUTO NA TABEST1
  with DataModule1.QRYSEQ do
  begin
    Close;
    SQL.Text := 'SELECT Controle, Produto FROM TABEST1 WITH (NOLOCK) WHERE CodInterno = :CodInterno';
    ParamByName('CodInterno').AsString := sCodInterno;
    Open;

    if IsEmpty then
    begin
      ShowMessage(Format('Produto com Cod. Interno %s não encontrado na base TABEST1.', [sCodInterno]));
      Close;
      Exit;
    end;
    iLkProduto := FieldByName('Controle').AsInteger;
    sNomeProduto := FieldByName('Produto').AsString;
    Close;
  end;


  // 3. EXECUÇÃO DA CONSULTA MESTRA (QRYPRODUTOSABERTOS) - CARREGA O PRODUTO E A RESERVA TOTAL
  with QRYPRODUTOSABERTOS do
  begin
    Close;
    SQL.Text :=
        'SELECT ' +
        '    B.LkProduto AS LkProduto, P.CodInterno, P.Produto, P.CodBarra, P.CodFornecedor, P.Moeda AS Localizacao, ' +
        '    G.Setor AS Grupo, P.Fabricante AS Marca, F.Empresa AS Fornecedor, P.Quantidade AS QtdEstoque, ' +
        '    CAST(SUM(B.Qtdreal) AS NUMERIC(12, 2)) AS QtdReserva, COUNT(DISTINCT A.Pedido) AS NumPedidos ' +
        'FROM TabEst3B B WITH (NOLOCK) ' +
        'INNER JOIN TabEst3A A WITH (NOLOCK) ON A.Pedido = B.PEDIDO ' +
        'INNER JOIN TABEST1 P WITH (NOLOCK) ON P.Controle = B.LkProduto ' +
        'LEFT JOIN TabEst8 G WITH (NOLOCK) ON P.LkSetor = G.Controle ' +
        'LEFT JOIN TabFor F WITH (NOLOCK) ON P.LkFornec = F.Controle ' +
        'WHERE A.Cancelada <> 1 AND A.VENDA <> 1 AND A.STATUS IN (''P'') ' + // Filtro de Status Aberto
        '  AND P.Controle = :LkProduto ' +
        'GROUP BY B.LkProduto, P.CodInterno, P.Produto, P.Quantidade, P.CodFornecedor, P.Moeda, G.Setor, P.Fabricante, F.Empresa, P.CodBarra ' +
        'ORDER BY P.Produto';

    ParamByName('LkProduto').AsInteger := iLkProduto;
    Open;
  end;



  // 6. Configura as Labels
  Label1.Caption := Format('Posição de Reserva do Produto: %s - %s', [sCodInterno, sNomeProduto]);
  Label2.Caption := 'Pedidos de Reserva Detalhados: (Clique para carregar)';

  Self.ShowModal;
end;











procedure TFormposicaoest.QRYPRODUTOSABERTOSAfterScroll(DataSet: TDataSet);
var
  LkProduto: Integer;
begin
  // 1. Garante que há um produto ativo na lista mestra
  if not DataSet.IsEmpty and DataSet.Active then
  begin
    LkProduto := DataSet.FieldByName('LkProduto').AsInteger;

    // 2. Fecha a query de detalhe
    QRYPEDIDOS.Close;

    // 3. Define a SQL (Garante que está configurada corretamente)
    QRYPEDIDOS.SQL.Text :=
      'SELECT ' +
      '    A.*, ' + // Traz todas as colunas de TabEst3A
      '    B.Qtdreal AS QuantidadeItem, ' + // Quantidade do item no pedido
      '    CASE ' +
      '        WHEN A.STATUS = ''P'' THEN ''PRÉ-VENDA'' ' +
      '        WHEN A.STATUS = ''O'' THEN ''ORÇAMENTO'' ' +
      '        ELSE ''OUTROS'' ' +
      '    END AS Situacao ' +
      'FROM TabEst3A A WITH (NOLOCK) ' +
      'INNER JOIN TabEst3B B WITH (NOLOCK) ON A.Pedido = B.PEDIDO ' +
      'WHERE A.Data >= :DataInicio AND A.Data <= :DataFim ' +
      '  AND A.Cancelada <> 1 ' +
      '  AND A.VENDA <> 1 ' +
      '  AND A.STATUS =''P'' ' +
      '  AND B.LkProduto = :LkProduto ' + // Filtro Mestre: ID do produto selecionado
      'ORDER BY A.Pedido DESC';

    // 4. Aplica os parâmetros
    QRYPEDIDOS.ParamByName('DataInicio').AsDateTime := frmmenu.dtinicio.Date;
    QRYPEDIDOS.ParamByName('DataFim').AsDateTime := frmmenu.dtfim.Date;
    QRYPEDIDOS.ParamByName('LkProduto').AsInteger := LkProduto; // Parâmetro Mestre

    // 5. Abre a consulta Detalhe
   QRYPEDIDOS.Open;

    // 6. Liga a fonte de dados detalhe (se já não estiver no FormShow)
   DSQRYPEDIDOS.DataSet := QRYPEDIDOS;
  DBGridpedidos.DataSource := DSQRYPEDIDOS;
  end
  else
  begin
    // Se a mestra estiver vazia ou inativa, garante que a detalhe está fechada
   QRYPEDIDOS.Close;
  end;
end;


end.

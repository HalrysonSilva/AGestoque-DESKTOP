unit FRMSENHA;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Buttons, Vcl.ExtCtrls,
  Data.DB, MemDS, DBAccess, Uni;

type
  TFRMSEN = class(TForm)
    Panel1: TPanel;
    Label1: TLabel;
    Cmbusuario: TComboBox;
    EditSenha: TEdit;
    Label2: TLabel;
    btnlogar: TBitBtn;
    QRYUSER: TUniQuery;
    QRYSENHA: TUniQuery;
    procedure FormShow(Sender: TObject);
    procedure CmbusuarioChange(Sender: TObject);
    procedure btnlogarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
    FUsuarioControle: Integer;
    property UsuarioControle: Integer read FUsuarioControle;
  end;

var
  FRMSEN: TFRMSEN;

implementation

{$R *.dfm}

uses CONEXAOBD, FRMAGESTOQUE;

procedure TFRMSEN.btnlogarClick(Sender: TObject);
const
  SENHA_PADRAO_DEV = '123'; // Senha fixa para desenvolvimento
begin
  // 1. Apenas verifica se a senha digitada corresponde ao código de desenvolvimento
  if EditSenha.Text = SENHA_PADRAO_DEV then
  begin
    // Sucesso: Atribui um CONTROLE e NÍVEL de desenvolvimento para avançar
    // (Em um cenário real, você carregaria as permissões a partir de um perfil fixo aqui)

    // O FUsuarioControle foi definido como 1 no FormShow.

    ShowMessage('Login de Desenvolvedor realizado com sucesso. Bem-vindo(a).');

    // Indica ao ShowModal no .dpr para abrir o próximo formulário
    ModalResult := mrOk;
  end
  else
  begin
    // Falha
    ShowMessage('Senha incorreta! A senha para desenvolvimento é: ' + SENHA_PADRAO_DEV);
    EditSenha.Clear;
    EditSenha.SetFocus;
  end;
end;

procedure TFRMSEN.CmbusuarioChange(Sender: TObject);
begin
  // 1. Garante que há um item selecionado
  if Cmbusuario.ItemIndex >= 0 then
  begin
    // 2. Recupera o CONTROLE (Integer) armazenado e salva no campo privado
    // Fazendo a conversão reversa de TObject para Integer
    FUsuarioControle := Integer(Cmbusuario.Items.Objects[Cmbusuario.ItemIndex]);
  end
  else
  begin
    FUsuarioControle := 0; // Nenhum usuário selecionado
  end;
end;



procedure TFRMSEN.FormShow(Sender: TObject);
var
  iControle: Integer;
begin
  Cmbusuario.Items.Clear;
  FUsuarioControle := 0; // Zera o controle ao iniciar

  if Assigned(DataModule1) and DataModule1.ConDados.Connected then
  begin
    with QRYUSER do
    begin
      Close;
      Connection := DataModule1.ConDados;

      // 1. Busca USUARIO E CONTROLE
      SQL.Text := 'SELECT USUARIO, CONTROLE FROM SERV ORDER BY USUARIO';
      Open;

      // 2. Carrega nomes e armazena o CONTROLE no TComboBox.Items.Objects
      while not Eof do
      begin
        iControle := FieldByName('CONTROLE').AsInteger;
        // Armazena o CONTROLE (Integer) no campo Objects (TObject)
        Cmbusuario.Items.AddObject(
          FieldByName('USUARIO').AsString,
          TObject(iControle)
        );
        Next;
      end;
      Close;

      // 3. Seleciona o primeiro usuário e atualiza a variável FUsuarioControle
      if Cmbusuario.Items.Count > 0 then
      begin
        Cmbusuario.ItemIndex := 0;
        // Chama a rotina Change para carregar o CONTROLE do primeiro item
        CmbusuarioChange(Cmbusuario);
        EditSenha.SetFocus;
      end;
    end;
  end
  else
  begin
    ShowMessage('Atenção: A conexão com o banco de dados não está ativa.');
  end;
end;

end.